<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Chart.JS tests</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.3/p5.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.3/addons/p5.dom.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.3/addons/p5.sound.min.js"
    type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.12.0/matter.min.js" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
    integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
    crossorigin="" />
  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
    integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
    crossorigin=""></script>
  <style>
    #issMap { height: 400px; } /* height is mandatory otherwise map won't come up */
  </style>
</head>

<body>
  <h1>Where is the ISS</h1>
  <p>
    Latitude: <span id="lat"></span>, Longitude: <span id="lon"></span>
  </p>
  <div id="issMap"></div>
  <script>
    // const mymap = L.map('issMap').setView([51.505, -0.09], 13);
    // Making map with tiles
    const mymap = L.map('issMap').setView([0, 0], 1);
    const attribution = "&copy; <a href='https://www.openstreetmap.org/copyright'>OpenStreet Maps</a>";
    const tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    const tiles = L.tileLayer(tileUrl, { attribution });
    tiles.addTo(mymap);

    // Making marker with custom icon
    const issIcon = L.icon({
      iconUrl: 'iss.png',
      iconSize: [50, 32],
      iconAnchor: [25, 16]
    });
    const marker = L.marker([0, 0], { icon: issIcon }).addTo(mymap);

    const api_url = 'https://api.wheretheiss.at/v1/satellites/25544';

    async function getISS() {
      const response = await fetch(api_url);
      const data = await response.json();
      // console.log(data);
      const { latitude, longitude } = data;
      // console.log(latitude, longitude);
      document.getElementById('lat').textContent = latitude;
      document.getElementById('lon').textContent = longitude;
      marker.setLatLng([ latitude, longitude]);
    }

    setInterval(function(){ getISS(); }, 1000);

    getISS();
  </script>


  <!-- CHART EXAMPLES WITH FETCH -->
  <!-- <canvas id="chart" width="800" height="400"></canvas>
    <img id="image" width="800" height="400" /> -->
  <script>

    // chartIt(); // Using chart.js
    // chartOnline(); // Using quickchart.io

    async function chartOnline() {
      const data = await getData(); // We can also do it like this here instead of chaining 'then'
      const url = 'https://quickchart.io/chart?width=800&height=400&c=';
      document.getElementById('image').src = url + JSON.stringify(await getChartData(data));
    }

    async function chartIt() {
      const data = await getData(); // We can also do it like this here instead of chaining 'then'
      const ctx = document.getElementById('chart').getContext('2d');
      const myChart = new Chart(ctx, await getChartData(data));
    }

    function getChartData(data) {
      return {
        type: 'line',
        data: {
          labels: data.xs,
          datasets: [{
            label: 'Global Average Temperature',
            data: data.ys,
            fill: false,
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            yAxes: [
              {
                ticks: {
                  callback: function (value, index, values) {
                    return value + 'Â°'; // Option + Shift + 8
                  }
                }
              }
            ]
          }
        }
      }
    }


    // getData().then (response => {
    //   chartIt();
    // });


    async function getData() {
      const xs = []; // Years
      const ys = []; // Global temp
      const nhems = []; // Northern hemisphere
      const shems = []; // Southern hemisphere
      const response = await fetch('ZonAnn.Ts+dSST.csv');
      const data = await response.text();
      //console.log(data);
      const table = data.split('\n').slice(1);
      //console.log(table);
      table.forEach(row => {
        const cols = row.split(',');
        //console.log(cols);
        const year = cols[0];
        xs.push(year);
        const temp = cols[1];
        ys.push(parseFloat(temp) + 14); // Global mean is 14 degrees
        // console.log(year, temp);

        nhems.push(parseFloat(cols[2] + 14));
        shems.push(parseFloat(cols[3] + 14));
      });
      //console.log(nhems, shems);

      return { xs, ys, nhems, shems };
    }

    // console.log('Fetching image');
    // normalFetch();
    //getImage()
    // .then(response => {
    //   console.log('Yes!!!');
    // })
    // .catch(error => {
    //   console.log('Error!!!');
    //   console.error(error);
    // });;

    async function getImage() {
      const response = await fetch('demo.jpg');
      const blob = await response.blob();
      document.getElementById('image').src = URL.createObjectURL(blob);
    }

    function normalFetch() {
      fetch('demo.jpg')
        .then(response => {
          console.log(response);
          return response.blob();
        })
        .then(blob => {
          console.log(blob);
          const url = URL.createObjectURL(blob);
          console.log(url);
          document.getElementById('image').src = url;
        })
        .catch(error => {
          console.log('Error!!!');
          console.error(error);
        });
    }
  </script>
</body>

</html>